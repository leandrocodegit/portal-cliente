<p-fluid>
  <div class="card flex">
    <div *ngIf="load" class="p-6 w-full">
      <app-skeleton />
    </div>
    <div *ngIf="!load" class="flex-col gap-6 w-full">
      <div class="font-semibold text-xl">Cadastro de usuários</div>

      <div class="flex flex-auto flex-wrap gap-6 w-full py-4">
        <div class="flex flex-col gap-4 flex-grow" [formGroup]="form">
          <div class="flex flex-wrap gap-2 w-full">
            <label for="firstname" class="required">Nome</label>
            <input formControlName="firstName" [class.border-error]="isInvalid('firstName')"
              [(ngModel)]="usuario.firstName" pInputText type="text" />
            @if (isInvalid('firstName')) {
            <span class="text-error">Nome é obrigatório</span>
            }
          </div>
          <div class="flex flex-wrap gap-2 w-full">
            <label for="lastName" class="required">Sobrenome</label>
            <input formControlName="lastName" [class.border-error]="isInvalid('lastName')"
              [(ngModel)]="usuario.lastName" pInputText type="text" />
            @if (isInvalid('lastName')) {
            <span class="text-error">Sobrenome é obrigatório</span>
            }
          </div>
          <div class="flex flex-wrap gap-2 w-full">
            <label for="username" class="required">CPF</label>
            <input formControlName="username" [class.border-error]="isInvalid('username')"
              [(ngModel)]="usuario.username" name="username" pInputText type="text" />
            @if (isInvalid('username')) {
            <span class="text-error">Documento é obrigatório</span>
            }
          </div>
          <div class="flex flex-wrap gap-2 w-full">
            <label for="email" class="required">Email</label>
            <input formControlName="email" [class.border-error]="isInvalid('email')" [(ngModel)]="usuario.email"
              pInputText type="text" />
            @if (isInvalid('email')) {
            <span class="text-error">Email inválido</span>
            }
          </div>
          <div class="flex flex-wrap gap-2 w-full">
            <label for="phone">Celular</label>
            <input formControlName="phone" [class.border-error]="isInvalid('phone')" [(ngModel)]="usuario.phone"
              pInputText type="text" />
          </div>
        </div>
        <div class="flex-grow mt-4 flex gap-4 flex-wrap lg:flex-nowrap">
          <p-fieldset legend="Departamentos/Setor" [toggleable]="false" [style]="{'height': '100%'}">
            <div class="flex flex-col gap-4">
              <p-multiselect (onChange)="joinGrupo($event)" [options]="departamentos"
                [(ngModel)]="usuario.departamentos" placeholder="Selecione grupos do usuário" optionLabel="description"
                [selectAll]="false" [showToggleAll]="false" styleClass="w-full md:w-80" display="chip">
                <ng-template let-grupo #item>
                  <div class="flex items-center gap-2">
                    <div>{{ grupo.description }}</div>
                  </div>
                </ng-template>
                <ng-template #dropdownicon>
                  <i class="pi pi-plus-circle"></i>
                </ng-template>
                <ng-template #filtericon>
                  <i class="pi pi-search"></i>
                </ng-template>
                <ng-template #header>
                  <div class="font-medium p-4">Departamentos</div>
                </ng-template>

              </p-multiselect>

              <div class="flex flex-col gap-4 py-4">
                <div *ngFor="let grupo of usuario.departamentos" class="flex items-center pb-2">
                  <i class="pi pi-check-circle text-teal-500"></i>
                  <label class="ml-2">{{grupo.description}}</label>
                </div>
              </div>
            </div>
          </p-fieldset>
          <p-fieldset legend="Controle de horário" [toggleable]="false" [style]="{'height': '100%'}">
            <div class="flex flex-col gap-4">
              <div class="flex items-center">
                <p-checkbox [(ngModel)]="usuario.controle_acesso.ativo" id="checkOption3" name="option" [binary]="true"
                  value="Quarta" />
                <label for="checkOption3" class="ml-2">Habilitar</label>
              </div>
              @if (usuario.controle_acesso.ativo) {
              <div class="flex items-center">
                <p-checkbox [(ngModel)]="usuario.controle_acesso.controlarHorario" id="checkHorario" name="option"
                  [binary]="true" />
                <label for="checkHorario" class="ml-2">Controlar horário</label>
              </div>
              @if(usuario.controle_acesso.controlarHorario){
              <div class="flex gap-4 flex-wrap lg:flex-nowrap">
                <div class="flex flex-wrap gap-2 w-full">
                  <label for="horario">Horário início</label>
                  <input [(ngModel)]="usuario.controle_acesso.inicio" pInputText type="time" />
                </div>
                <div class="flex flex-wrap gap-2 w-full">
                  <label for="horario">Horário término</label>
                  <input [(ngModel)]="usuario.controle_acesso.fim" pInputText type="time" />
                </div>
              </div>
              <div class="flex flex-wrap gap-2 w-full">
                <label for="horario">Tempo de tolerância (Min)</label>
                <input [(ngModel)]="usuario.controle_acesso.tolerancia" pInputText type="number" />
              </div>
              }
              <div class="flex items-center">
                <p-checkbox [(ngModel)]="usuario.controle_acesso.controlarDias" id="checkDias" name="option"
                  [binary]="true" />
                <label for="checkDias" class="ml-2">Controlar dias da semana</label>
              </div>
              @if(usuario.controle_acesso.controlarDias){
              <p-multiselect [options]="['SEG','TER','QUA','QUI','SEX','SAB','DOM']"
                [(ngModel)]="usuario.controle_acesso.dias" [maxSelectedLabels]="3"
                placeholder="Selecione os dias da semana" display="chip">
                <ng-template #item let-dia>
                  <div class="flex items-center">
                    <div>{{ diaDescriptions[dia] }}</div>
                  </div>
                </ng-template>
              </p-multiselect>
              <app-horario-atendimento [horario]="usuario.controle_acesso.inicio + ':' + usuario.controle_acesso.fim"
                [dias]="usuario.controle_acesso.dias" />
              }
              }
            </div>
          </p-fieldset>
        </div>
        <p-fieldset legend="Controle de perfil" [toggleable]="false" [style]="{'height': '100%'}">
          <div class="flex flex-col gap-4">
            <div class="flex gap-2">
              <p-select [options]="permissoes" [(ngModel)]="permissaoUsuario" optionLabel="nome" dataKey="id"
                placeholder="Selecione uma permissão para o usuário" class="w-full col-span-4" [style]="{'max-width': '200px'}" />
                <div class="flex gap-2 justify-between grow">
              <p-button (onClick)="atualizarPermissao()" [outlined]="true" [disabled]="!permissaoUsuario || permissaoUsuario == usuario.permissao" label="Atualizar perfil" icon="pi pi-refresh" [style]="{'max-width': '200px'}"/>
              <p-button (onClick)="removerOtp()" [outlined]="true" severity="danger" label="Resetar 2FA" icon="pi pi-trash" [style]="{'max-width': '200px'}"/>
            </div>
            </div>
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 py-4">
              <div *ngFor="let grupo of usuario.groups" class="flex items-center pb-2">
                <i class="pi pi-check-circle text-teal-500"></i>
                <label class="ml-2">{{grupo.nome}}</label>
              </div>
            </div>
          </div>
        </p-fieldset>
      </div>
      <app-voltar-salvar (salvarEmit)="salvar()"></app-voltar-salvar>
    </div>
  </div>
</p-fluid>
